<%
    master="../../master/detail.html";
%>

<view1>
    <style type="text/css">
    div.container {
        margin: 6px 10px;
        height:100%;

        padding: 10px 4px;
        /*box-shadow:0 2px 10px #ccc;
         border: solid 1px #ccc;*/
        margin-top:10px;

    }
    div.tree {
        overflow: auto;
        width: 250px;
    }
    div.container>div.item {
        float:left;
        margin:10px;
        padding:2px;
    }
    </style>
    <script src="<%=rootUrl %>/content/js/openflow.category.js"></script>
    <script src="<%=rootUrl %>/content/js/openflow.template.js?ver=<%= version%>"></script>
    <script src="<%=rootUrl %>/content/js/openflow.instance.js?ver=<%= version%>"></script>
    <script type="text/javascript" src="<%=rootUrl %>/content/easyui/datagrid-detailview.js"></script>
</view1>
<view2>
<div class="container">
    <div class="tree item">
        <ul id="treeCategory"></ul>
    </div>
    <div id="templates item">
          <table id="tbTemplates"></table>
    </div>
    <div class="clear"></div>
</div>
        <script type="text/javascript">
        function refreshCategory() {
            //获取当前用户分类
            openflow.category.search(function(data) {
                if(data) {
                    openflow.category.data = data;
                    searchMyTemplate();
                }
            });
        }

        refreshCategory();

        //生成模板表格
        function createTree(data,other) {
            data = data || openflow.category.data;
            var d = [{
                'id':'mycategory',
                'text':'自己创建的流程',
                'children':[
                    {
                        id:'mywithcategory',
                        'text':'我的分类',
                        'children':openflow.category.createDataTree(data,0)
                    },
                    {
                        id:'mynoncategory',
                        'text':'未分组流程'
                    }
                ]
            }];
           //添加非自已创建的分类
                d.push({
                    'id':'othercategory',
                    'text':'非自己创建的流程',
                    'children':openflow.category.createDataTree(other,0)
                });


            //生成其它分类
            $('#treeCategory').tree({
                data:d,
                onSelect:function(node) {
                    var data = [];//openflow.category.templates;
                    if(openflow.category.templates) {
                        for(var i=0;i<openflow.category.templates.length;i++) {
                            var t = openflow.category.templates[i];
                            if(node.id == 'mycategory') {
                                if(t.CreateUser == openflow.user) {
                                    data.push(t);
                                }
                            }
                            else if(node.id == 'mywithcategory') {
                                if(t.CreateUser == openflow.user && t.CategoryId && t.CategoryName) {
                                    data.push(t);
                                }
                            }
                            else if(node.id == 'mynoncategory') {
                                if(t.CreateUser == openflow.user && (!t.CategoryId || !t.CategoryName)) {
                                    data.push(t);
                                }
                            }
                            else if(node.id == 'othercategory') {
                                if(t.CreateUser != openflow.user) {
                                    data.push(t);
                                }
                            }
                            else {
                                if(t.CategoryId == node.id) {
                                    data.push(t);
                                }
                            }
                        }
                        createTable(data);
                    }
                }
            });
        }

        function searchMyTemplate() {
            openflow.request('post',{
                url:openflow.root + 'servers/templateServer.js?cmd=searchWithCategoryByUser',
                user:openflow.user
            },function(data) {
                openflow.category.templates = data;
                if(data) {
                    //获取其它权限的分类
                    var otherCategories = {categories:[]};
                    for(var i=0;i<data.length;i++) {
                        var d = data[i];
                        if(d.CreateUser == openflow.user) continue;
                        var ctid = d.CategoryId;
                        var ctname = d.CategoryName;
                        if(ctid && ctname && !otherCategories[ctid]) {
                            otherCategories[ctid] = {
                                Id:ctid,
                                Name:ctname,
                                Parent:d.CategoryParent
                            };
                            otherCategories.categories.push(otherCategories[ctid]);
                        }
                    }
                    createTree(null,otherCategories.categories);//生成分类树
                    createTable(data);
                }
            });
        }

        $('#tbTemplates').datagrid({
                columns:[[{field:'Name',title:'名称',sortable:true},{field:'Description',title:'说明',align:'left'},{field:'Flag',title:'状态',sortable:true,width:100},{field:'CreateUser',title:'创建人',sortable:true},{field:'CreateOn',title:'创建时间'}]],
                singleSelect:true
            });

        //生成模板表格
    function createTable(data) {
        if (data) {
            for (var i = 0; i < data.length; i++) {
                var opname= '作废';
                var mname= 'invalidTemplate';
                var opclass = 'cell_del';
                var flag = '有效';
                if(data[i].Flag == 2) {
                    opname= '恢复';
                    mname= 'enableTemplate';
                    opclass= 'cell_restore';
                    flag='无效';
                }
                var date = $jm.parseDate(data[i].LastUpdateOn);
                var namecell='';
                namecell ='<a class="cell_op cell_copy" href="#" onclick="javascript:return copyTemplate.call(this,'+data[i].Id+',\''+data[i].Name+'\',\''+data[i].Description+'\');" title="复制">&nbsp;</a>';
                namecell += '<a href="#" class="cell_op '+opclass+'" onclick="javascript:return '+mname+'('+data[i].Id+');" title="'+opname+'">&nbsp;</a>';
                //namecell += '<a href="#" class="cell_op cell_plus" data-template="'+data[i].Id+'" onclick="javascript:return showTemplateInstance(this,true);" title="展开或收缩">&nbsp;</a>';
                namecell += '&nbsp;&nbsp;<a href="/editor.js?mode=0&id='+data[i].Id+'"  target="_blank" data-template="'+data[i].Id+'">('+ +data[i].Id+ ')&nbsp;' + data[i].Name +'</a>';

                data[i].Name = namecell;

                data[i].CreateOn =$jm.formatDate($jm.parseDate(data[i].CreateOn),'yyyy-MM-dd HH:mm:ss');
                data[i].Flag = flag;
            }
        }
        $('#tbTemplates').datagrid({data:data});
        $('#tbTemplates').datagrid({
                view:detailview,
                detailFormatter:function(index,row) {
                    return '<div style="padding:2px;"><table id="div-'+index+'"></table></div>';
                },
                onExpandRow: function(index,row) {
                    showTemplateInstance('#div-' + index,index,row);
                }});
        resetParentHeight();
    }

     /**
    * 显示此模板相关的实例
    */
    function showTemplateInstance(div,index,data) {
        $(div).datagrid({
                columns:[[{field:'Name',title:'实例名称'},{field:'State',title:'状态'}]],
                fitColumns:true,
                rownumbers:true  ,
                onResize:function() {
                    $('#tbTemplates').datagrid('fixDetailRowHeight',index);
                    //重置父页高度
                    resetParentHeight();
                }
            });


        search(div,index,data);
        function search(div,index,row) {
            var order = '';//instanceTB.sort?instanceTB.sort.toString():'';
            //instancesContainer.html('<div class="jm_wait">加载中...</div>');
            openflow.request('post', {
                page: 1,
                flag:0,
                templateId:row.Id,
                count: 20,
                orderby:'a.CreateOn desc',
                url: openflow.root + 'servers/instanceServer.js?cmd=search'
            }, function (data,err) {
                if (data) {
                    /*if(data.data.length > 0) {
                        instancesContainer.show();
                    }*/
                    createTable(data.data,div,index,row);
                }
                else if(err) {
                    openflow.message.error(err.toString());
                }
            });
        }
        //生成模板表格
        function createTable(data,div,index,row) {
            //instanceTB.rows=[];
            if (data) {
                for (var i = 0; i < data.length; i++) {
                    var namecell = '&nbsp;<a href="/editor.js?mode=3&id=' + data[i].TemplateId + '&instance=' + data[i].Id + '" target="_blank">(' +data[i].Id+ ')&nbsp;' +
                    (data[i].Name || '') + '</a>';
                    var statename = openflow.instanceStatus.getStateName(data[i].State);
                   /* instanceTB.insertRow([
                    {
                        value: namecell,
                        style: 'width:200px;'
                    },
                    statename]);*/
                    data[i].Name = namecell;
                    data[i].State = statename;
                }
            }
            //header: [{value:"实例名称",name:'a.Name'}, {value:'状态',name:'a.State'}]
            //instanceTB.render();
            $(div).datagrid({
                data:data
            });
            $('#tbTemplates').datagrid('fixDetailRowHeight',index);
        }
    }
    /**
    * 作废
    */
    function invalidTemplate(id) {
        openflow.template.invalidTemplate(id,function(r) {
            if(r) {
                search(0);
            }
        });
        return false;
    }
    /**
    * 恢复
    */
    function enableTemplate(id) {
        openflow.template.enableTemplate(id,function(r) {
            if(r) {
                search(0);
            }
        });
        return false;
    }

    /**
    * 复制当前模板
    */
    function copyTemplate(id,name,des) {
        openflow.template.copyTemplate.call(this,id,name,des,function(r) {
            if(r) {
                search(0);
            }
        });
        return false;
    }
    </script>
</view2>
